// ####################################################################################################################
// # Packages
// #####################################################################################################################
const express = require('express'),
	bodyParser = require('body-parser'),
	sequelize = require('sequelize'),
	_ = require('lodash'),
	async = require('async');

// #####################################################################################################################
// # Instances
// #####################################################################################################################
let app = express(),
	database = require('./database.js'),
	scaffoldRouter = require('./lib/scaffoldRouter.js');

// #####################################################################################################################
// # Models
// #####################################################################################################################
var User = database.define('user', {
	username: {
		allowNull: false,
		type: sequelize.STRING,
		validate: {
			notEmpty: true
		}
	},
	birthday: sequelize.DATE
});

// #####################################################################################################################
// # Database
// #####################################################################################################################
database.sync({force: true})
		.then(()=>{
			console.log('database synced');
			return User.create({
				username: 'michael',
				birthday: new Date(1990, 4, 2)
			})
		})
		.then((user)=>{
			console.log(user.get({
				plain: true
			}))
		});

app.use((req, res, next)=>{
	req.models = {
		User
	}
	next();
});

// #####################################################################################################################
// # Routes
// #####################################################################################################################
let indexRouter = express.Router();
let usersRouter = scaffoldRouter(User);

indexRouter.get('/', (req, res)=>{
	res.json({});
});

// #####################################################################################################################
// # Middleware
// #####################################################################################################################
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({extended: true}));
app.use('/', indexRouter);
app.use('/users', usersRouter);

// #####################################################################################################################
// # Start server
// #####################################################################################################################
app.listen(30005, ()=>{
	console.log('listening on 30005');
});
